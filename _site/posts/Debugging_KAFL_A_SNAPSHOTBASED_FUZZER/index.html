<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Debugging kAFL, A Snapshot-based Fuzzer" /><meta property="og:locale" content="en" /><meta name="description" content="kAFL" /><meta property="og:description" content="kAFL" /><link rel="canonical" href="http://localhost:4000/posts/Debugging_KAFL_A_SNAPSHOTBASED_FUZZER/" /><meta property="og:url" content="http://localhost:4000/posts/Debugging_KAFL_A_SNAPSHOTBASED_FUZZER/" /><meta property="og:site_name" content="林中木屋" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-01-31T00:00:00-06:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Debugging kAFL, A Snapshot-based Fuzzer" /><meta name="twitter:site" content="@mhskai2017" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-02-22T10:53:14-06:00","datePublished":"2024-01-31T00:00:00-06:00","description":"kAFL","headline":"Debugging kAFL, A Snapshot-based Fuzzer","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/Debugging_KAFL_A_SNAPSHOTBASED_FUZZER/"},"url":"http://localhost:4000/posts/Debugging_KAFL_A_SNAPSHOTBASED_FUZZER/"}</script><title>Debugging kAFL, A Snapshot-based Fuzzer | 林中木屋</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="林中木屋"><meta name="application-name" content="林中木屋"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="preconnect" href="https://polyfill.io" ><link rel="dns-prefetch" href="https://polyfill.io" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.25.0/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return 'mode'; } static get MODE_ATTR() { return 'data-mode'; } static get DARK_MODE() { return 'dark'; } static get LIGHT_MODE() { return 'light'; } static get ID() { return 'mode-toggle'; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia('(prefers-color-scheme: dark)'); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { document.documentElement.removeAttribute(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage( { direction: ModeToggle.ID, message: this.modeStatus }, '*' ); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/pfp.jpeg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">林中木屋</a></h1><p class="site-subtitle fst-italic mb-0">Kiwids</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/Fun-Reads/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>FUN READS</span> </a><li class="nav-item"> <a href="/notes/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>NOTES</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/kiwids0220" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/mhskai2017" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['someone','nowhere'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Debugging kAFL, A Snapshot-based Fuzzer</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Debugging kAFL, A Snapshot-based Fuzzer</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1706680800" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 31, 2024 </time> </span> <span> Updated <time data-ts="1708620794" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 22, 2024 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/mhskai2017">Kiwi</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1474 words" > <em>8 min</em> read</span></div></div></header><div class="content"><h1 id="kafl">kAFL</h1><p>Right of the bat, these sources act as the single sources of truth if you want to get a deeper understanding of kAFL: <a href="https://www.usenix.org/system/files/conference/usenixsecurity17/sec17-schumilo.pdf">kAFL White Paper</a> <a href="https://intellabs.github.io/kAFL/tutorials/introduction.html">kAFL Doc</a></p><h1 id="whats-the-blogpost-about">What’s the blogpost about?</h1><p>Recently, I wanted to dive into the world of fuzzing, espcially kernel fuzzing, which is what led me to this project. I knew nothing about Fuzzing, what’s a fuzzer, harness, corpus, frontend, backend, mutator, snapshot-based fuzzing. None of these made sense to me, so kAFL is the perfect project for me to dive in and learn about all those concepts.</p><p>I wanted to utilize kAFL to fuzz Windows kernel drivers/core system component, but while the Github repo provided a great example for both fuzzing against the kernel mode target and the user mode target, I still find myself stuck in a suitiation where the fuzzer does not work the way I inteded. Well, the most important question is, how do we figure it out? The only answer is to start debugging..</p><h2 id="kafl-infrastructure"><span class="me-2">kAFL Infrastructure</span><a href="#kafl-infrastructure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The white paper ^ has nice explanation for kAFL’s internal infrastructure, you can also find it on their github</p><h2 id="debugging-the-kafl-python-frontend"><span class="me-2">Debugging the kAFL Python Frontend</span><a href="#debugging-the-kafl-python-frontend" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The frontend fuzzer kAFL itself is written in Python, and the vscode is prob the best option here to debug anything in Python. So I find the <code class="language-plaintext highlighter-rouge">__main__.py</code> and put a couple breakpoints <a href="/assets/images/main.py-1.png" class="popup img-link shimmer"><img src="/assets/images/main.py-1.png" alt="mainPy" loading="lazy"></a> Upon creating the Python debug configuration file and launching it with <code class="language-plaintext highlighter-rouge">kafl fuzz</code>, it hits those breakpoints but I was unable to continue debugging because the function <code class="language-plaintext highlighter-rouge">qemu._connect()</code> will fail due to a socket error. It turns out the frontend python script is communicating to the QEMU instance via <code class="language-plaintext highlighter-rouge">UNIX Socket</code> as documented in the kAFL documentation, and the socket was not yet established by QEMU-Nyx. So what can we do? The answer is easy, just start the QEMU instance ourselves.</p><p><a href="/assets/images/2024-01-31-QEMU-connect.py.png" class="popup img-link shimmer"><img src="/assets/images/2024-01-31-QEMU-connect.py.png" alt="" loading="lazy"></a> <a href="https://intellabs.github.io/kAFL/reference/workdir_layout.html">Doc</a></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>├── interface_N                  - socket between kAFL worker N and Qemu N
</pre></table></code></div></div><h2 id="patch-kafl-python-frontend"><span class="me-2">Patch kAFL Python Frontend</span><a href="#patch-kafl-python-frontend" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The kAFL fuzzer will prepare all the QEMU auguments internally and kick off the QEMU process for us. As you see in the screenshot above, I have commented out the <code class="language-plaintext highlighter-rouge">subprocess</code> which now the kADL will not do this. The reason is that While QEMU provides useful stub <code class="language-plaintext highlighter-rouge">-S, -s</code> for pausing the VM image at it’s first vCPU execution, we would still love to pause the QEMU process at the initialization phase (i.e., Machine/CPU/Peripheral initialization) which is the actual <code class="language-plaintext highlighter-rouge">main()</code> function in <code class="language-plaintext highlighter-rouge">vl.c</code> file (QEMU 4.2.0 release).</p><p>So, we can tell the python script to pause at <code class="language-plaintext highlighter-rouge">qemu.connect()</code> and then start the QEMU-Nyx instance ourself -&gt; wait for the QEMU-Nyx socket to listen for connection -&gt; continue the frontend fuzzer -&gt; we can now continue the debugging process</p><p>To achieve this, I leveraged <code class="language-plaintext highlighter-rouge">debugpy</code> which is what vscode uses under the hood for python debugging</p><p><a href="/assets/images/2024-01-31-Start.png" class="popup img-link shimmer"><img src="/assets/images/2024-01-31-Start.png" alt="" loading="lazy"></a></p><p>And the configuration file <a href="/assets/images/2024-01-31-config-port.png" class="popup img-link shimmer"><img src="/assets/images/2024-01-31-config-port.png" alt="" loading="lazy"></a></p><h2 id="building-qemu-nyx-yourself"><span class="me-2">Building QEMU-Nyx yourself</span><a href="#building-qemu-nyx-yourself" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you look at the repo <a href="https://github.com/nyx-fuzz/QEMU-Nyx">QEMU-Nyx</a>, you will see it included a <a href="https://github.com/nyx-fuzz/QEMU-Nyx/blob/qemu-nyx-4.2.0/compile_qemu_nyx.sh">.sh</a> script to build the QEMU-Nyx with a few options <a href="/assets/images/2024-01-31-compilesh.png" class="popup img-link shimmer"><img src="/assets/images/2024-01-31-compilesh.png" alt="" loading="lazy"></a> Here is the actual flags being passed to configure <a href="/assets/images/2024-01-31-compileflag.png" class="popup img-link shimmer"><img src="/assets/images/2024-01-31-compileflag.png" alt="" loading="lazy"></a></p><p>This is done so that we can get the full symbol for the <code class="language-plaintext highlighter-rouge">qemu-system-x86_64</code> and start debugging with <code class="language-plaintext highlighter-rouge">gdb</code>.</p><h2 id="putting-it-together"><span class="me-2">Putting it together</span><a href="#putting-it-together" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Follow the procedure of building your vm image using vagrant and ansible playbook -&gt; start the fuzzer with <code class="language-plaintext highlighter-rouge">kafl fuzz --purge -w /tmp/whatever</code> (-w for setting the working directory) -&gt; make sure the interface_0 unix socket exist in the folder, attach to the python script debugpy and start debugging.</p><p><a href="/assets/images/2024-01-31-QEMU-Nyx%20handshake.png" class="popup img-link shimmer"><img src="/assets/images/2024-01-31-QEMU-Nyx%20handshake.png" alt="" loading="lazy"></a><a href="/assets/images/2024-01-31-pwndbg.png" class="popup img-link shimmer"><img src="/assets/images/2024-01-31-pwndbg.png" alt="" loading="lazy"></a></p><h2 id="getting-full-system-dump-while-fuzzing"><span class="me-2">Getting Full System Dump While Fuzzing</span><a href="#getting-full-system-dump-while-fuzzing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The kAFL patches the monitor/GUI interface when it starts, so we can’t really utilize the qemu monitor command line to snatch a full system memory dump while the fuzzer is running.</p><h3 id="pausing-fuzzer-and-collecting-memory-dump"><span class="me-2">Pausing Fuzzer And Collecting Memory Dump</span><a href="#pausing-fuzzer-and-collecting-memory-dump" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>You can technically “pause” the fuzzer and get your system dump there. To make sure the Windows guest vm is able to collect a full system memory dump in QEMU, we need to make sure that it installs the <code class="language-plaintext highlighter-rouge">FwCfg driver</code> which is included in the <code class="language-plaintext highlighter-rouge">virt-io</code> ISO installer, for more detailed instruction, I found this blog very helpful <a href="https://daynix.github.io/2023/02/19/Guest-Windows-debugging-and-crashdumping-under-QEMU-KVM-dump-guest-memory-vmcoreinfo-and-virtio-win.html">Guest Windows debugging and crashdumping under QEMU/KVM: dump-guest-memory, vmcoreinfo and virtio-win</a></p><p>Well the trick to “pause” the fuzzer is simply reapplying what I talked about in the <a href="#putting-it-together">Putting It Together</a> with another trick - using socat. The details is documented <a href="https://unix.stackexchange.com/questions/426652/connect-to-running-qemu-instance-with-qemu-monitor">QEMU monitor with socat</a>.</p><p>Here is how you do it:</p><ul><li>We are still gonna run the same command line argument with our GDB/Pwndbg, but this time adding <code class="language-plaintext highlighter-rouge">-device vmcoreinfo --monitor unix:qemu-monitor-socket,server,nowait</code> at the end</ul><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>gdb --args "./x86_64-softmmu/qemu-system-x86_64" -enable-kvm -machine kAFL64-v1 -cpu kAFL64-Hypervisor-v1,+vmx -no-reboot -net none -display none -chardev socket,server,id=nyx_socket,path=/tmp/kafl_kiwi/interface_0 -device nyx,chardev=nyx_socket,workdir=/tmp/kafl_kiwi,worker_id=0,bitmap_size=65536,input_buffer_size=131072 -device isa-serial,chardev=kafl_serial -chardev file,id=kafl_serial,mux=on,path=/tmp/kafl_kiwi/serial_00.log -m 4096 -drive file=/home/kiwi/.local/share/libvirt/images/windows_x86_64_vagrant-kafl-windows.img -fast_vm_reload path=/tmp/kafl_kiwi/snapshot/,load=off -device vmcoreinfo --monitor unix:qemu-monitor-socket,server,nowait
</pre></table></code></div></div><ul><li>Kick off kAFL fuzzer frontend (patching out the subprocess.run that kick off another QEMU instance because we are doing it with gdb already)<li>After the fuzzing loop starts, hit <code class="language-plaintext highlighter-rouge">Crtl + C</code> in gdb<li>Go into the gdb directly, and connect to the QEMU monitor using <code class="language-plaintext highlighter-rouge">socat -,echo=0,icanon=0 unix-connect:qemu-monitor-socket</code><li>Run <code class="language-plaintext highlighter-rouge">dump-guest-memory -w memory.dmp</code> in the monitor CLI<li>Continue the execution in gdb</ul><p>After that you should be able to collect a full system dump</p><p><a href="/assets/images/2024-01-31-systemdump.png" class="popup img-link shimmer"><img src="/assets/images/2024-01-31-systemdump.png" alt="" loading="lazy"></a></p><h2 id="debugging-the-windows-dump"><span class="me-2">Debugging the Windows Dump?</span><a href="#debugging-the-windows-dump" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This is not your typical dump you collected from a kernel panic crash or from WinDbg. This is the dump we collected via some additional loops in QEMU monitor. Since the dump we had is in WinDbg-compatible format, we can leverage WinDbg again to troubleshoot where the “Hang” comes from…</p><h2 id="dump-analysis-using-windbg"><span class="me-2">Dump Analysis Using WinDbg</span><a href="#dump-analysis-using-windbg" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Well, telling WinDbg to analyze our dump is quite easy, just simply drag and drop the <code class="language-plaintext highlighter-rouge">.dmp</code> file into WinDbg and run <code class="language-plaintext highlighter-rouge">!analyze -v</code>. <a href="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3.png" class="popup img-link shimmer"><img src="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3.png" alt="" loading="lazy"></a></p><p>After the WinDbg finished analyzing, we can find our harness by locating the process Ex. <code class="language-plaintext highlighter-rouge">!process 0 0 lsass.exe</code>.<br /> We may also list information regarding all threads running under our harness process with <code class="language-plaintext highlighter-rouge">!process 0 7 lsass.exe</code> <a href="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-1.png" class="popup img-link shimmer"><img src="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-1.png" alt="" loading="lazy"></a> Right off the bat, we find our thread that’s running our harness, however, it is at a wait stage as the WinDbg says: <a href="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-3.png" class="popup img-link shimmer"><img src="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-3.png" alt="" loading="lazy"></a> A couple of things worth noting:</p><ul><li>This is a Alertable event that the thread is waiting for.<li>The <code class="language-plaintext highlighter-rouge">NoficationEvent</code> - Describe the type of Events. (more on <code class="language-plaintext highlighter-rouge">Event</code> objects can be found <a href="https://learn.microsoft.com/en-us/windows/win32/sync/event-objects">here</a> and <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/wdm/nf-wdm-keinitializeevent">here</a>)</ul><h3 id="please-wait"><span class="me-2">Please Wait()</span><a href="#please-wait" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We know the thread is waiting for the Event to be “Signaled” so our thread can continue executing our harness. But what function lead to the <code class="language-plaintext highlighter-rouge">NtWaitForSingleObjet()</code>. The answer can be found yet again in the screenshot - <code class="language-plaintext highlighter-rouge">Sspi!LsaRegisterLogonProcess()</code>. <a href="https://learn.microsoft.com/en-us/windows/win32/api/ntsecapi/nf-ntsecapi-lsaregisterlogonprocess">LsaRegisterLogonProcess</a> is a interesting function and Microsoft documented as</p><blockquote><p>The <strong>LsaRegisterLogonProcess</strong> function establishes a connection to the LSA server and verifies that the caller is a logon application.</p></blockquote><p>If we open the function in IDA, we will find where the call is made! <a href="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-4.png" class="popup img-link shimmer"><img src="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-4.png" alt="" loading="lazy"></a></p><h3 id="finding-the-event-in-windbg"><span class="me-2">Finding the Event in WinDbg</span><a href="#finding-the-event-in-windbg" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If you want to know how to find this “named” Event object in WinDbg dump, check out <a href="/posts/Useful-Pwndbg-&amp;-WinDbg-Commands/">my other note</a>.</p><p>We will be utilizing some old MS WinDbg extension called <a href="https://github.com/DebugPrivilege/InsightEngineering/tree/main/Debugging%20101/Section%201%3A%20Introduction%20to%20MEX">Mex</a>, Thanks for the people who made this extension and also <a href="https://twitter.com/DebugPrivilege">@DebugPrivilege</a> who documented the usefulness of it.</p><p>Once you downloaded Mex and extracted to disk, run <code class="language-plaintext highlighter-rouge">.load PATH_TO_MEX.dll</code> in your WinDbg console.</p><p>After that, we can utilize its <code class="language-plaintext highlighter-rouge">!p</code> to dump the process information given our <code class="language-plaintext highlighter-rouge">lsass.exe</code> address. Next, we can list all threads information by just clicking on the <code class="language-plaintext highlighter-rouge">!mex.listthreads</code> <a href="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-5.png" class="popup img-link shimmer"><img src="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-5.png" alt="" loading="lazy"></a> We found the same thread that was running our harness, and now let’s list more detail about the thread. Look, there’s our <code class="language-plaintext highlighter-rouge">Event</code> we just saw previously in IDA, and the name also matches. <a href="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-6.png" class="popup img-link shimmer"><img src="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-6.png" alt="" loading="lazy"></a> Now we can further inspect the <code class="language-plaintext highlighter-rouge">Object</code> by following the link of the address pointing to our <code class="language-plaintext highlighter-rouge">NotificationEvent</code>. The <code class="language-plaintext highlighter-rouge">WaitBlockList</code> is a field of <code class="language-plaintext highlighter-rouge">nt!_THREAD</code> struct which specifies a list of synchronization object that the thread is waiting on, find more info <a href="https://codemachine.com/articles/kernel_structures.html">here</a>. <a href="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-7.png" class="popup img-link shimmer"><img src="/assets/images/02-18-20242024-02-18-Debugging_KAFL_A_SNAPSHOTBASED_FUZZER_3-7.png" alt="" loading="lazy"></a></p><h2 id="kafl-timeout"><span class="me-2">kAFL Timeout</span><a href="#kafl-timeout" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Perhaps it was too early for the Event to be set for listening or the thread that’s supposed to signal the Event hasn’t done so (because of the “hacky” way I injected my harness), our harness thread was “hanging” at this point. Since kAFL is a snapshot-based fuzzer, it utilize <code class="language-plaintext highlighter-rouge">QEMU-Nyx</code> to achieve <strong>rapid VM reload</strong> at the point where the system snapshot was taken and when the execution ends. kAFL also specifies <strong>soft/hard timeouts</strong> for execution, if harness thread is <strong>blocked/put into a wait state</strong>, and if the <strong>thread was blocked for the duration that’s longer than the timeout</strong>, then the <strong>VM will be reset by the fuzzer</strong>. In this case, our <code class="language-plaintext highlighter-rouge">Event</code> was not signaled which caused our harness thread “hangs” virtually forever and kAFL resetted the VM, the infinite loop keeps on going…</p><h2 id="closing"><span class="me-2">Closing</span><a href="#closing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It was very interesting diving into the fuzzer and troubleshoot our harness problem. This whole journey sparked my interested in Fuzzing, Hypervisor studies and I am excited for the future blog posts!</p><p>Happy lunar new year and see you on the other side!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/virtualization/">Virtualization</a>, <a href="/categories/kafl/">kAFL</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/fuzz/" class="post-tag no-text-decoration" >fuzz</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Debugging%20kAFL,%20A%20Snapshot-based%20Fuzzer%20-%20%E6%9E%97%E4%B8%AD%E6%9C%A8%E5%B1%8B&url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FDebugging_KAFL_A_SNAPSHOTBASED_FUZZER%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Debugging%20kAFL,%20A%20Snapshot-based%20Fuzzer%20-%20%E6%9E%97%E4%B8%AD%E6%9C%A8%E5%B1%8B&u=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FDebugging_KAFL_A_SNAPSHOTBASED_FUZZER%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=http%3A%2F%2Flocalhost%3A4000%2Fposts%2FDebugging_KAFL_A_SNAPSHOTBASED_FUZZER%2F&text=Debugging%20kAFL,%20A%20Snapshot-based%20Fuzzer%20-%20%E6%9E%97%E4%B8%AD%E6%9C%A8%E5%B1%8B" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/Stalking-Inside_of_Your_chromium_Browser/">Stalking inside of your Chromium Browser</a><li class="text-truncate lh-lg"> <a href="/posts/Nyx-Deep-Dive-Part-1/">Deep Diving into Nyx Part I - The Setup</a><li class="text-truncate lh-lg"> <a href="/posts/Nyx-Deep-Dive-Part-2/">Deep Diving into Nyx Part II - QEMU QOM Initialization</a><li class="text-truncate lh-lg"> <a href="/posts/NT-Filesystem-Internals-Study-Notes/">NT Filesystem Internals Study Notes</a><li class="text-truncate lh-lg"> <a href="/posts/Debugging_KAFL_A_SNAPSHOTBASED_FUZZER/">Debugging kAFL, A Snapshot-based Fuzzer</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/qemu/">QEMU</a> <a class="post-tag btn btn-outline-primary" href="/tags/fuzz/">fuzz</a> <a class="post-tag btn btn-outline-primary" href="/tags/notes/">notes</a> <a class="post-tag btn btn-outline-primary" href="/tags/pwndbg/">Pwndbg</a> <a class="post-tag btn btn-outline-primary" href="/tags/redteam/">redteam</a> <a class="post-tag btn btn-outline-primary" href="/tags/windbg/">WinDbg</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/Nyx-Deep-Dive-Part-1/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1708322400" data-df="ll" > Feb 19, 2024 </time><h4 class="pt-0 my-2">Deep Diving into Nyx Part I - The Setup</h4><div class="text-muted"><p> The Setup Clone &amp;amp; Compare I figured the best way to learn what modification that the Nyx has made on top of QEMU is to cloning both repos and compare all files that has been modified/added/del...</p></div></div></a></article><article class="col"> <a href="/posts/Nyx-Deep-Dive-Part-2/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1708322400" data-df="ll" > Feb 19, 2024 </time><h4 class="pt-0 my-2">Deep Diving into Nyx Part II - QEMU QOM Initialization</h4><div class="text-muted"><p> QEMU Initialization After setting up the debugger and mess around within the QEMU-Nyx, I found a couple of interesting spots that might worth documenting. QEMU Class Type Registration QEMU befo...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/Stalking-Inside_of_Your_chromium_Browser/" class="btn btn-outline-primary" aria-label="Older" ><p>Stalking inside of your Chromium Browser</p></a> <a href="/posts/Useful-Pwndbg-&-WinDbg-Commands/" class="btn btn-outline-primary" aria-label="Newer" ><p>Useful Pwndbg & WinDbg Commands</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2024</time> <a href="https://twitter.com/mhskai2017">Kiwi</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/qemu/">QEMU</a> <a class="post-tag btn btn-outline-primary" href="/tags/fuzz/">fuzz</a> <a class="post-tag btn btn-outline-primary" href="/tags/notes/">notes</a> <a class="post-tag btn btn-outline-primary" href="/tags/pwndbg/">Pwndbg</a> <a class="post-tag btn btn-outline-primary" href="/tags/redteam/">redteam</a> <a class="post-tag btn btn-outline-primary" href="/tags/windbg/">WinDbg</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="https://cdn.jsdelivr.net/combine/npm/jquery@3.7.1/dist/jquery.min.js,npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js,npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/magnific-popup@1.1.0/dist/jquery.magnific-popup.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.10/dayjs.min.js,npm/dayjs@1.11.10/locale/en.min.js,npm/dayjs@1.11.10/plugin/relativeTime.min.js,npm/dayjs@1.11.10/plugin/localizedFormat.min.js,npm/tocbot@4.25.0/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
